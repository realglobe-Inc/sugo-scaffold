/**
 * Run spot
 * @function spot
 * @returns {Promise}
 */
'use strict'

const pkg = require('../package.json')
const sugoSpot = require('sugo-spot')
const co = require('co')
const debug = require('debug')('~~~~package_name@enumcase~~~~:spot')
const noop = require('sugo-interface-noop')
const colorprint = require('colorprint')
const pudding = require('pudding')({ lang: 'en' })

let configs = require('./configs')

/** @lends spot */
function spot () {
  debug('Example spot invoked')
  let { port, hostname } = configs()
  let url = `http://${hostname}:${port}/spots`

  let { SPOT_KEY } = process.env

  let context = spot.newContext()
  let key = SPOT_KEY || context.key

  colorprint.notice(`[${pkg.name}] Running spot script...`)
  colorprint.trace('Settings: %s', { port, hostname, key })

  return co(function * () {
    let instance = sugoSpot(url, {
      key,
      interfaces: {
        noop: noop()
      },
      force: true
    })
    yield instance.connect()
    return instance
  })
}

Object.assign(spot, {
  newContext () {
    return pudding.explode({
      key: '${spinalcase([this.color, this.fish].join("-")).trim()}'
    }, 1)[0]
  }
})

module.exports = spot
