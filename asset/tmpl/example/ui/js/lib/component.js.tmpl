/**
 * Root component to mount.
 * @class Component
 */
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _agent = require('sugo-cloud/agent');

var _agent2 = _interopRequireDefault(_agent);

var _sugoAgentFile = require('sugo-agent-file');

var _sugoAgentFile2 = _interopRequireDefault(_sugoAgentFile);

var _sugoAgentCompile = require('sugo-agent-compile');

var _sugoAgentCompile2 = _interopRequireDefault(_sugoAgentCompile);

var _sugoReactExample = require('sugo-react-example');

var _sgReactComponents = require('sg-react-components');

var _sgReactComponents2 = _interopRequireDefault(_sgReactComponents);

var _apemanReactBasic = require('apeman-react-basic');

var _apemanReactBasic2 = _interopRequireDefault(_apemanReactBasic);

var _asleep = require('asleep');

var _asleep2 = _interopRequireDefault(_asleep);

var _co = require('co');

var _co2 = _interopRequireDefault(_co);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _sugoCaller = require('sugo-caller');

var _sugoCaller2 = _interopRequireDefault(_sugoCaller);

var _sgReact = require('sg-react');

var _sgReact2 = _interopRequireDefault(_sgReact);

var _sugoObserver = require('sugo-observer');

var _sugoObserver2 = _interopRequireDefault(_sugoObserver);

var _snippets = require('./snippets');

var _markdowns = require('./markdowns');

var _markdowns2 = _interopRequireDefault(_markdowns);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

require('babel-polyfill');

var RequirePool = {
  co: _co2.default,
  os: _os2.default,
  asleep: _asleep2.default,
  'react': _react2.default,
  'sugo-caller': _sugoCaller2.default,
  'sugo-observer': _sugoObserver2.default,
  'sg-react': _sgReact2.default,
  'sg-react-components': _sgReactComponents2.default,
  'apeman-react-basic': _apemanReactBasic2.default
};

/** @lends Component */
var Component = _react2.default.createClass({
  displayName: 'Component',

  // --------------------
  // Specs
  // --------------------

  propTypes: {
    /** Port number of the cloud */
    port: _react.PropTypes.number,
    /** Hostname of the cloud */
    hostname: _react.PropTypes.string,
    /** Package data */
    pkg: _react.PropTypes.object,
    /** Theme color */
    color: _react.PropTypes.string
  },

  getInitialState: function getInitialState() {
    var s = this;
    var props = s.props;

    return {
      html: _snippets.DEFAULT_HTML,
      script: _snippets.DEFAULT_SCRIPT,
      tab: 'DEMO',
      content: 'default',
      playground: false,
      reading: false,
      refreshing: false,
      tooltip: null,
      cloud: {},
      callers: [],
      actors: [],
      globals: {
        require: function require(name) {
          if (RequirePool[name]) {
            return RequirePool[name];
          }
          return window.require(name);
        }
      }
    };
  },
  render: function render() {
    var s = this;
    var state = s.state;
    var props = s.props;
    var pkg = props.pkg;
    var tab = state.tab;
    var script = state.script;
    var html = state.html;
    var globals = state.globals;
    var cloud = state.cloud;
    var actors = state.actors;
    var callers = state.callers;

    return _react2.default.createElement(
      'div',
      null,
      _react2.default.createElement(
        _sugoReactExample.SgExample,
        null,
        _react2.default.createElement(_sugoReactExample.SgExampleHeader, _extends({ tab: tab, pkg: pkg }, {
          actors: actors,
          runActor: function runActor() {
            return s.setState({ tooltip: _markdowns2.default['12.Connect Actor'] });
          },
          onTabChange: function onTabChange(e) {
            return s.setTab(e.tab);
          } })),
        _react2.default.createElement(
          _sugoReactExample.SgExampleBody,
          { hidden: tab !== 'DEMO' },
          _react2.default.createElement(_sugoReactExample.SgExampleAbout, { pkg: pkg }),
          _react2.default.createElement(_sugoReactExample.SgExampleStatus, { actors: actors,
            callers: callers,
            cloud: cloud,
            spinning: state.refreshing,
            onRefresh: s.refreshStatus
          }),
          _react2.default.createElement(_sugoReactExample.SgExamplePlayground, _extends({ html: html, script: script, globals: globals }, {
            compile: s.compileScript,
            onChange: s.handleChange,
            pipeConsole: true,
            closed: !state.playground,
            onToggle: s.togglePlayground,
            defaultHtml: _snippets.DEFAULT_HTML,
            defaultScript: _snippets.DEFAULT_SCRIPT
          }))
        ),
        _react2.default.createElement(
          _sugoReactExample.SgExampleBody,
          { hidden: tab !== 'GUIDES' },
          _react2.default.createElement(_sugoReactExample.SgExampleInstruction, { src: [_markdowns2.default['11.Setup Cloud'], _markdowns2.default['12.Connect Actor'], _markdowns2.default['13.Use Caller']], vars: s.getMarkdownVars() }),
          _react2.default.createElement(_sugoReactExample.SgExampleLinks, { links: require('../../../doc/links.json') })
        ),
        _react2.default.createElement(_sugoReactExample.SgExampleFooter, null),
        _react2.default.createElement(_sugoReactExample.SgExampleTooltip, { onClose: function onClose() {
            return s.setState({ tooltip: null });
          },
          src: state.tooltip,
          vars: s.getMarkdownVars(),
          hidden: !state.tooltip
        })
      )
    );
  },
  componentDidMount: function componentDidMount() {
    var s = this;
    var _window$location = window.location;
    var protocol = _window$location.protocol;
    var host = _window$location.host;
    var hash = _window$location.hash;

    s.observer = (0, _sugoObserver2.default)(protocol + '//' + host + '/observers', function (data) {
      var playground = s.state.playground;

      if (!playground) {
        s.refreshStatus();
      }
    });

    s.compileAgent = (0, _sugoAgentCompile2.default)('/dynamic/compile');
    s.fileAgent = (0, _sugoAgentFile2.default)('/dynamic/contents');
    s.cloudAgent = (0, _agent2.default)();

    s.observer.start();
    s.refreshStatus();
    s.setTab(String(hash).replace(/^#/, '').toUpperCase());
  },
  componentWillUnmount: function componentWillUnmount() {
    var s = this;
    s.observer.stop();
  },


  // --------------------
  // custom
  // --------------------

  setTab: function setTab(tab) {
    var s = this;
    var valid = tab && !!~['DEMO', 'GUIDES'].indexOf(tab);
    s.setState({ tab: valid ? tab : 'DEMO' });
    window.location.hash = String(tab).toLowerCase();
  },
  handleChange: function handleChange(e) {
    var s = this;
    var state = s.state;
    var _e$values = e.values;
    var html = _e$values.html;
    var script = _e$values.script;
    var globals = _e$values.globals;

    s.setState({ html: html, script: script, globals: globals });
    s.tryAsync('saving', (0, _co2.default)(regeneratorRuntime.mark(function _callee() {
      var fileAgent;
      return regeneratorRuntime.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              fileAgent = s.fileAgent;
              _context.next = 3;
              return fileAgent.write(state.content + '.html', html);

            case 3:
              _context.next = 5;
              return fileAgent.write(state.content + '.jsx', script);

            case 5:
            case 'end':
              return _context.stop();
          }
        }
      }, _callee, this);
    })));
  },
  compileScript: function compileScript(script) {
    var s = this;
    var compileAgent = s.compileAgent;

    return compileAgent.compile(script);
  },
  refreshStatus: function refreshStatus() {
    var s = this;
    var state = s.state;
    var cloudAgent = s.cloudAgent;
    var _window = window;
    var location = _window.location;

    if (!location) {
      return;
    }
    s.tryAsync('refreshing', (0, _co2.default)(regeneratorRuntime.mark(function _callee2() {
      var actors, callers, cloud, globals;
      return regeneratorRuntime.wrap(function _callee2$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              _context2.next = 2;
              return cloudAgent.actors();

            case 2:
              actors = _context2.sent;
              _context2.next = 5;
              return cloudAgent.callers();

            case 5:
              callers = _context2.sent;
              cloud = { host: location.host };
              globals = Object.assign(state.globals, { actors: actors });

              s.setState({ actors: actors, callers: callers, cloud: cloud, globals: globals });

            case 9:
            case 'end':
              return _context2.stop();
          }
        }
      }, _callee2, this);
    })));
  },
  tryAsync: function tryAsync(name, promise) {
    var delay = arguments.length <= 2 || arguments[2] === undefined ? 300 : arguments[2];

    var s = this;
    if (s.state[name]) {
      return Promise.resolve(true);
    }
    return Promise.resolve().then(function () {
      return (0, _asleep2.default)(delay);
    }).then(function () {
      return s.setState(_defineProperty({}, name, true));
    }).then(function () {
      return promise;
    }).catch(function (err) {
      return console.error(err);
    }).then(function () {
      return s.setState(_defineProperty({}, name, false));
    });
  },
  togglePlayground: function togglePlayground() {
    var s = this;
    var state = s.state;

    var playground = !state.playground;
    s.setState({ playground: playground });
    if (playground) {
      s.tryAsync('reading', (0, _co2.default)(regeneratorRuntime.mark(function _callee3() {
        var fileAgent, state, html, script;
        return regeneratorRuntime.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                fileAgent = s.fileAgent;
                state = s.state;
                _context3.next = 4;
                return fileAgent.read(state.content + '.html');

              case 4:
                html = _context3.sent;
                _context3.next = 7;
                return fileAgent.read(state.content + '.jsx');

              case 7:
                script = _context3.sent;

                s.setState({
                  html: html || state.html,
                  script: script || state.script
                });

              case 9:
              case 'end':
                return _context3.stop();
            }
          }
        }, _callee3, this);
      })));
    }
  },
  getMarkdownVars: function getMarkdownVars() {
    var s = this;
    var _window2 = window;
    var location = _window2.location;

    return {
      __your_host__: location && location.host,
      __your_actor_name__: '__your_actor_name__' // TODO
    };
  }
});

exports.default = Component;
//# sourceMappingURL=data:application/json;base64,bnVsbA==