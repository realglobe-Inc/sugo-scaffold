/**
 * List Item Component of a actor.
 */
import React from 'react'
import { connect } from 'react-redux'
import SgButton from 'sg-react-components/lib/sg_button'
import {modalWindow, toggleRequesting} from '../actions'
import co from 'co'
import classnames from 'classnames'

const debug = require('debug')('sg:site:actor_list_item')

let ActorListItem = React.createClass({
  propTypes: {
    actor: React.PropTypes.object
  },

  render () {
    const s = this
    let {props} = s
    let {actor} = props
    let {requesting} = actor
    return (
      <div className={classnames('actor-list-item', requesting ? 'requesting' : '')}>
        <div className='actor-list-item-key'>
          {actor.key}
        </div>
        <div>
          <i className={classnames(
            'actor-list-item-spinning',
            requesting ? 'visible' : 'hidden',
            'fa',
            'fa-spinner',
            'fa-pulse',
            'fa-1x',
            'fa-fw'
          )}></i>
        </div>
        <SgButton className='actor-list-item-button' onTap={s.onPing} disabled={requesting}>
          Ping
        </SgButton>
      </div>
    )
  },

  onPing () {
    const s = this
    const {actor, startPingRequest, openPongWindow} = s.props
    co(function * () {
      debug('ping')
      startPingRequest()
      let res = yield actor.caller.get('noop').ping()
      if (res === 'pong') {
        debug(res)
        openPongWindow()
      }
    }).catch(err => {
      console.error(err)
    })
  }
})

const mapDispatchToProps = (dispatch, props) => {
  return {
    openPongWindow () {
      dispatch(modalWindow())
      dispatch(toggleRequesting(props.actor.key))
    },
    startPingRequest () {
      dispatch(toggleRequesting(props.actor.key))
    }
  }
}

ActorListItem = connect(null, mapDispatchToProps)(ActorListItem)

export default ActorListItem
